<template>
	<div>
		<div class="bg-white text-baseB header-container relative">주문내역</div>
		<div class="h-[48px]"></div>
		<div class="mainpage-bg">
			<div
				v-if="orderList.orders && orderList.orders.length === 0"
				class="h-[668px] grid gap-5 content-center"
			>
				<div class="mx-auto">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="48"
						height="32"
						viewBox="0 0 48 32"
						fill="none"
					>
						<g clip-path="url(#clip0_1194_2451)">
							<path
								d="M6.93873 19.5447C5.43729 19.5447 4.16579 19.2421 3.12425 18.6365C2.08308 18.0309 1.29584 17.1954 0.7629 16.1299C0.254302 15.04 0 13.8168 0 12.4607C0 11.1772 0.230321 9.82067 0.69024 8.39187C1.15052 6.93873 1.82878 5.5826 2.72464 4.32309C3.6452 3.03961 4.78337 1.99807 6.13952 1.19884C7.52 0.399609 9.11847 0 10.9349 0C12.4367 0 13.6959 0.290626 14.7131 0.87188C15.7546 1.4288 16.5295 2.22803 17.0381 3.26957C17.571 4.28677 17.8373 5.47361 17.8373 6.82973C17.8373 7.79867 17.692 8.86413 17.4013 10.0267C17.1351 11.1649 16.7111 12.3034 16.1299 13.4415C15.5729 14.5557 14.8583 15.5729 13.9865 16.4931C13.1146 17.4133 12.0854 18.1523 10.8985 18.7092C9.73607 19.2661 8.4162 19.5447 6.93873 19.5447ZM7.30207 16.6385C8.48887 16.6385 9.5304 16.3235 10.4263 15.6939C11.3225 15.0643 12.0734 14.2651 12.6787 13.2963C13.2843 12.3034 13.7445 11.2738 14.0591 10.2083C14.3741 9.11847 14.5314 8.11327 14.5314 7.19307C14.5314 6.2485 14.3741 5.46126 14.0591 4.83169C13.7445 4.20211 13.2963 3.72985 12.715 3.41488C12.1337 3.07593 11.4435 2.90628 10.6443 2.90628C9.4334 2.90628 8.36793 3.22125 7.44733 3.85083C6.52715 4.45642 5.75226 5.2433 5.12232 6.21218C4.51709 7.18107 4.05681 8.19827 3.74184 9.2638C3.42723 10.3293 3.26957 11.3101 3.26957 12.2064C3.26957 13.1509 3.42723 13.9621 3.74184 14.6404C4.08115 15.2943 4.55341 15.7909 5.15865 16.1299C5.76425 16.4688 6.47883 16.6385 7.30207 16.6385ZM20.5827 5.30397C19.3715 5.30397 18.2089 5.12232 17.0951 4.75904C15.9809 4.37141 14.8911 3.85082 13.8255 3.19691C13.5106 3.00327 13.3409 2.74897 13.3169 2.43401C13.2683 2.11903 13.3289 1.81642 13.4986 1.52579C13.6439 1.23516 13.8495 1.02919 14.1162 0.908213C14.3581 0.7629 14.5885 0.7629 14.8064 0.908213C15.4117 1.29584 16.0536 1.63478 16.7318 1.92541C17.4097 2.21603 18.1487 2.43401 18.9479 2.57933C19.7227 2.72464 20.5583 2.79729 21.4545 2.79729C22.1324 2.79729 22.8953 2.74897 23.7432 2.65198C24.6151 2.53101 25.4747 2.34936 26.3225 2.10705C27.1701 1.84076 27.9087 1.53778 28.5386 1.19884C28.8049 1.02918 29.0472 1.06552 29.2651 1.30783C29.4831 1.55014 29.5921 1.84077 29.5921 2.17971C29.6161 2.51865 29.4831 2.77296 29.1925 2.94261C27.4727 3.86281 25.8986 4.49275 24.4698 4.83169C23.065 5.14666 21.7691 5.30397 20.5827 5.30397ZM28.7573 19.5447C27.2558 19.5447 25.9843 19.2421 24.9428 18.6365C23.9013 18.0309 23.1144 17.1954 22.5815 16.1299C22.0729 15.04 21.8185 13.8168 21.8185 12.4607C21.8185 11.1772 22.0485 9.82067 22.5088 8.39187C22.9691 6.93873 23.6469 5.5826 24.5432 4.32309C25.4634 3.03961 26.6019 1.99807 27.9581 1.19884C29.3385 0.399609 30.937 0 32.7534 0C34.2549 0 35.5144 0.290626 36.5316 0.87188C37.5731 1.4288 38.348 2.22803 38.8566 3.26957C39.3895 4.28677 39.6559 5.47361 39.6559 6.82973C39.6559 7.79867 39.5105 8.86413 39.2199 10.0267C38.9536 11.1649 38.5297 12.3034 37.9484 13.4415C37.3915 14.5557 36.6769 15.5729 35.805 16.4931C34.9331 17.4133 33.9039 18.1523 32.7171 18.7092C31.5546 19.2661 30.2348 19.5447 28.7573 19.5447ZM29.1206 16.6385C30.3074 16.6385 31.3486 16.3235 32.2448 15.6939C33.1411 15.0643 33.8916 14.2651 34.4972 13.2963C35.1028 12.3034 35.5627 11.2738 35.8777 10.2083C36.1927 9.11847 36.3499 8.11327 36.3499 7.19307C36.3499 6.2485 36.1927 5.46126 35.8777 4.83169C35.5627 4.20211 35.1148 3.72985 34.5335 3.41488C33.9523 3.07593 33.262 2.90628 32.4628 2.90628C31.252 2.90628 30.1861 3.22125 29.2659 3.85083C28.3457 4.45642 27.5705 5.2433 26.9409 6.21218C26.3353 7.18107 25.8753 8.19827 25.5604 9.2638C25.2454 10.3293 25.0881 11.3101 25.0881 12.2064C25.0881 13.1509 25.2454 13.9621 25.5604 14.6404C25.8993 15.2943 26.3716 15.7909 26.9772 16.1299C27.5828 16.4688 28.297 16.6385 29.1206 16.6385ZM40.2938 5.08599C39.9305 5.08599 39.5189 5.02533 39.0586 4.90435C38.5987 4.75903 38.1627 4.57739 37.7508 4.35942C37.3149 4.14145 36.9395 3.91149 36.6246 3.66918C36.4066 3.49953 36.2737 3.25758 36.225 2.94261C36.1767 2.62765 36.201 2.32503 36.2977 2.0344C36.3703 1.71943 36.4916 1.48946 36.6609 1.34415C36.8306 1.19883 37.0242 1.21083 37.2422 1.38048C37.8961 1.86474 38.4653 2.17971 38.9496 2.32502C39.4343 2.446 39.8822 2.50667 40.2938 2.50667C40.9477 2.50667 41.5413 2.38569 42.0739 2.14338C42.6311 1.87709 43.1637 1.59846 43.6723 1.30783C44.1809 0.99286 44.7019 0.71458 45.2345 0.472266C45.7917 0.229955 46.385 0.108981 47.0145 0.108981C47.3779 0.108981 47.6321 0.254299 47.7775 0.544928C47.9471 0.811213 48.0197 1.12619 47.9954 1.48947C47.9715 1.82841 47.8381 2.14337 47.5958 2.43401C47.3779 2.70029 47.0633 2.83362 46.6513 2.83362C46.1913 2.83362 45.7311 2.9426 45.2708 3.16057C44.8109 3.37855 44.3143 3.64484 43.7813 3.95981C43.2727 4.25043 42.7278 4.51673 42.1465 4.75904C41.5653 4.97701 40.9477 5.08599 40.2938 5.08599Z"
								fill="#555555"
							/>
							<path
								d="M28.9611 24.1221C29.5471 23.3316 29.8177 23.3135 30.2326 22.3057C31.5041 19.2178 28.0529 21.2159 28.9611 24.1221ZM28.9611 24.1221C29.6303 25.2211 31.1409 28.8449 29.6877 30.298C28.4173 31.5684 25.5099 30.6613 24.7833 27.755M28.9611 24.1221C27.9861 25.4379 25.9539 27.2507 24.7833 27.755M24.7833 27.755C19.1525 29.2081 13.9953 24.6384 10.7969 21.3975M26.8352 26.5547C27.1945 26.8624 27.8469 28.0972 27.8985 28.5673"
								stroke="#555555"
								stroke-width="2"
							/>
							<path
								d="M9.62701 16.7111C11.1317 16.7111 12.3516 15.4912 12.3516 13.9864C12.3516 12.4817 11.1317 11.2618 9.62701 11.2618C8.12221 11.2618 6.90234 12.4817 6.90234 13.9864C6.90234 15.4912 8.12221 16.7111 9.62701 16.7111Z"
								fill="#1CB08C"
							/>
							<path
								d="M31.4244 16.7111C32.9291 16.7111 34.149 15.4912 34.149 13.9864C34.149 12.4817 32.9291 11.2618 31.4244 11.2618C29.9196 11.2618 28.6997 12.4817 28.6997 13.9864C28.6997 15.4912 29.9196 16.7111 31.4244 16.7111Z"
								fill="#1CB08C"
							/>
						</g>
						<defs>
							<clipPath id="clip0_1194_2451">
								<rect width="48" height="32" fill="white" />
							</clipPath>
						</defs>
					</svg>
				</div>
				<p class="text-bodyBlack text-sm text-center">음식 주문내역이 없어요</p>
			</div>
			<div v-else class="grid-gap">
				<div
					v-for="(order, index) in orderList.orders"
					:key="index"
					class="order-list-card"
				>
					<div class="flex justify-between">
						<div>
							<p class="text-lg">{{ orderList.orderItemsInfo[index].name }}</p>
							<p class="text-sm pb-2 text-bodyBlack">
								{{ formatDate(order.pickupTime) }}
							</p>
							<p class="text-base pb-1">
								{{ getOrderStatusMessage(order.status) }}
							</p>
							<p class="text-base">{{ formatNumber(order.totalPrice) }}원</p>
						</div>
						<div>
							<div class="flex justify-end pt-[1px] pb-[13px]">
								<button
									class="flex items-center text-sm"
									@click="openModal(order.id)"
								>
									더보기

									<svg
										xmlns="http://www.w3.org/2000/svg"
										width="24"
										height="24"
										viewBox="0 0 24 24"
										fill="none"
									>
										<path
											d="M12.6 12L8.69999 8.10005C8.51665 7.91672 8.42499 7.68338 8.42499 7.40005C8.42499 7.11672 8.51665 6.88338 8.69999 6.70005C8.88332 6.51672 9.11665 6.42505 9.39999 6.42505C9.68332 6.42505 9.91665 6.51672 10.1 6.70005L14.7 11.3C14.8 11.4 14.8708 11.5084 14.9125 11.625C14.9542 11.7417 14.975 11.8667 14.975 12C14.975 12.1334 14.9542 12.2584 14.9125 12.375C14.8708 12.4917 14.8 12.6 14.7 12.7L10.1 17.3C9.91665 17.4834 9.68332 17.575 9.39999 17.575C9.11665 17.575 8.88332 17.4834 8.69999 17.3C8.51665 17.1167 8.42499 16.8834 8.42499 16.6C8.42499 16.3167 8.51665 16.0834 8.69999 15.9L12.6 12Z"
											fill="#1D1D1D"
										/>
									</svg>
								</button>
							</div>
							<div class="product-img-box">
								<img
									:src="
										fullImageUrl(
											orderList.orderItemsInfo[index].productImageUrl,
										)
									"
									alt="Product Image"
									class="product-img"
								/>
							</div>
						</div>
					</div>
				</div>
				<receiptModal
					v-if="isModalOpen"
					@close="closeModal"
					class="absolute"
					:orderId="selectedOrderId"
				></receiptModal>
			</div>
		</div>
	</div>
</template>
<script setup>
import { orderListApi } from '@/api/product.js';
import { onMounted, ref } from 'vue';
import receiptModal from '@/components/Modal/receiptModal.vue';
import { useStore } from 'vuex';

const store = useStore();
// 주문 목록
const orderList = ref([]);
const selectedOrderId = ref('');
// 모달 상태
const isModalOpen = ref(false);
// 모달 열기
const openModal = orderId => {
	selectedOrderId.value = orderId;
	isModalOpen.value = true;
};
// 모달 닫기
const closeModal = () => {
	isModalOpen.value = false;
};

onMounted(() => {
	fetchOrders();
});

const fetchOrders = async () => {
	try {
		const response = await orderListApi();

		if (response.data.success) {
			orderList.value = response.data;
		} else {
			console.error(
				'주문 목록을 가져오는 데 실패했습니다:',
				response.data.message,
			);
		}
	} catch (error) {
		console.error('Error', error);
	} finally {
		store.commit('SET_IS_LOADING', false);
	}
};

// 날짜 포맷
const formatDate = dateString => {
	// "YYYY-MM-DD HH:MM:SS" 형식의 문자열을 Date 객체로 변환
	const [datePart, timePart] = dateString.split(' ');
	const [year, month, day] = datePart.split('-');
	const [hours, minutes] = timePart.split(':');

	// 오전/오후 구분
	const ampm = hours >= 12 ? '오후' : '오전';
	const formattedHours = hours % 12 || 12; // 0을 12로 변환
	const formattedMinutes = String(minutes).padStart(2, '0'); // 분을 2자리로 포맷

	// "YYYY-MM-DD 오후 5:12" 형식으로 반환
	return `${year}-${month}-${day} ${ampm} ${formattedHours}:${formattedMinutes}`;
};

// 주문 상태 메시지 반환
const getOrderStatusMessage = status => {
	if (status === 'PENDING') {
		return '음식을 기다리는 중';
	} else if (status === 'COMPLETED') {
		return '픽업완료';
	}
	return '';
};

// 이미지 경로 변환
const fullImageUrl = imagePath => {
	const baseUrl = import.meta.env.VITE_APP_API_URL;
	return `${baseUrl}${imagePath}`;
};

// 숫자 포맷 (천단위 , 삽입)
const formatNumber = number => {
	return new Intl.NumberFormat().format(number);
};
</script>
<style lang="scss" scoped>
.header-container {
	height: 48px;
	width: 375px;
	padding: 12px 16px;
	justify-content: space-between;
	text-align: center;
	top: 0;
	background-color: white;
	position: absolute;
	z-index: 10;
}
.mainpage-bg {
	width: 375px;
	min-height: 716px;
	background-image: url('/mainPage/mainPageBg.png');
	color: var(--Text, #1d1d1d);
	background-attachment: fixed;
	background-repeat: no-repeat;
	background-position: center;
}
.grid-gap {
	display: grid;
	gap: 16px;
	padding: 16px;
}
.order-list-card {
	width: 342px;
	height: 148px;
	border-radius: 10px;
	border: 1px solid var(--Border_, #c6c6c6);
	margin: 0 auto;
	padding: 16px;
}
.product-img-box {
	width: 80px;
	height: 80px;
}
.product-img {
	width: 100%;
	height: 100%;
	background-color: white;
	border-radius: 6px;
	object-fit: cover;
}
</style>
